import os, re
from shodan import Shodan
from utils.gpt_client import ask_gpt

SHODAN_API_KEY = os.getenv("SHODAN_API_KEY")

def do_recon(target_ip, logger):
    recon_info = {}
    if SHODAN_API_KEY:
        api = Shodan(SHODAN_API_KEY)
        host = api.host(target_ip)
        recon_info['shodan'] = {"ports": host.get('ports', []), "data": host}
        logger.info(f"Shodan data for {target_ip}: {recon_info['shodan']}")
    prompt = f"Target IP {target_ip} reconnaissance summary: {recon_info.get('shodan','')}"
    gpt_resp = ask_gpt(prompt)
    recon_info['gpt'] = gpt_resp
    return recon_info